<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Live Chat</title>
    <style>
      :root{
        --bg1:#0f1724;
        --bg2:#0b3a5b;
        --card:#0e2738;
        --accent:#06b6d4;
        --muted:#9ca3af;
        --mine:#0369a1;
        --other:#162c3a;
      }
      *{box-sizing:border-box}
      body{
        margin:0;min-height:100vh;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
        background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#e6eef4;
        display:flex;align-items:center;justify-content:center;padding:24px
      }
      .chat{width:100%;max-width:820px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.6);overflow:hidden;display:flex;flex-direction:column}
      .header{padding:18px 20px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent);display:flex;align-items:center;gap:12px}
      .logo{width:44px;height:44px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;color:#04263a}
      .title{font-size:18px;font-weight:600}
      .subtitle{font-size:12px;color:var(--muted);margin-left:auto}

      /* join overlay */
      .overlay{position:absolute;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center}
      .join{background:linear-gradient(180deg,#07263a,#08304a);padding:20px;border-radius:12px;min-width:260px}
      .join input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);margin-top:8px;background:transparent;color:inherit}
      .join button{margin-top:10px;width:100%;padding:10px;border-radius:8px;border:none;background:var(--accent);color:#04263a;font-weight:700}

      #messages{list-style:none;margin:0;padding:18px;display:flex;flex-direction:column;gap:10px;overflow-y:auto;max-height:60vh}

      .message{display:flex;gap:10px;align-items:flex-end;max-width:78%}
      .avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#04263a;background:#e6eef4;color:#04263a}
      .bubble{padding:10px 12px;border-radius:12px;color:#e6eef4;font-size:14px;line-height:1.3}
      .bubble .meta{display:block;font-size:11px;color:var(--muted);margin-top:6px;text-align:right}
      .other .bubble{background:var(--other);border-top-left-radius:4px;align-self:flex-start}
      .mine{margin-left:auto;flex-direction:row-reverse}
      .mine .bubble{background:linear-gradient(90deg,var(--mine),#075985);border-top-right-radius:4px}
      .sender{font-weight:600;font-size:12px;color:#dff6fb;margin-bottom:6px}

      .composer{display:flex;padding:12px;background:linear-gradient(180deg,rgba(0,0,0,0.03),transparent);gap:8px}
      .composer input{flex:1;padding:12px 14px;border-radius:999px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:inherit;font-size:14px}
      .composer button{background:var(--accent);border:none;color:#04263a;padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer}
      .composer button:active{transform:translateY(1px)}

      @media (max-width:480px){.chat{border-radius:8px} .logo{width:38px;height:38px}}
    </style>
  </head>
  <body>
    <div class="chat" role="region" aria-label="Live chat">
      <div class="header">
        <div class="logo">LC</div>
        <div>
          <div class="title">Live Chat</div>
          <div class="subtitle">Real-time messages â€” no account needed</div>
        </div>
      </div>

      <ul id="messages" aria-live="polite"></ul>

      <form id="form" class="composer">
        <input id="input" autocomplete="off" placeholder="Type a message and press Enter" />
        <button type="submit">Send</button>
      </form>

      <div id="overlay" class="overlay" aria-hidden="false" style="display:flex">
        <div class="join" role="dialog" aria-label="Select room">
          <div style="font-weight:700;font-size:16px">Select or Create Room</div>
          <div id="roomList"></div>
          <input id="newRoomName" placeholder="New room name" />
          <label><input type="checkbox" id="isPrivate"> Private</label>
          <input id="roomPassword" placeholder="Password (if private)" type="password" />
          <button id="createRoomBtn" onclick="createRoom()">Create Room</button>
          <button id="joinBtn" style="display:none">Join Room</button>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      alert('Script starting');
      const socket = io();
      const form = document.getElementById('form');
      const input = document.getElementById('input');
      const messages = document.getElementById('messages');
      const overlay = document.getElementById('overlay');
      const roomList = document.getElementById('roomList');
      const newRoomName = document.getElementById('newRoomName');
      const isPrivate = document.getElementById('isPrivate');
      const roomPassword = document.getElementById('roomPassword');
      const createRoomBtn = document.getElementById('createRoomBtn');
      const joinBtn = document.getElementById('joinBtn');

      let username = '';
      let currentRoom = null;

      // Load user
      fetch('/user').then(res => {
        alert('Fetch user response status: ' + res.status);
        return res.json();
      }).then(data => {
        alert('User data: ' + JSON.stringify(data));
        if (data.username) {
          username = data.username;
          loadRooms();
        } else {
          alert('No username, but continuing');
          // window.location.href = '/login.html';
          loadRooms(); // for testing
        }
      }).catch(err => {
        alert('Fetch user error: ' + err);
      });

      function loadRooms() {
        alert('Loading rooms');
        fetch('/rooms').then(res => res.json()).then(rooms => {
          alert('Rooms loaded: ' + rooms.length);
          roomList.innerHTML = '';
          rooms.forEach(room => {
            const btn = document.createElement('button');
            btn.textContent = room.name;
            btn.onclick = () => joinRoom(room._id);
            roomList.appendChild(btn);
          });
        }).catch(err => {
          alert('Load rooms error: ' + err);
        });
      }

      createRoomBtn.addEventListener('click', async () => {
        alert('Create button clicked');
        const name = newRoomName.value.trim();
        if (!name) {
          alert('Enter room name');
          return;
        }
        alert('Sending request');
        const res = await fetch('/create-room', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, isPrivate: isPrivate.checked, password: roomPassword.value })
        });
        alert('Response received');
        const data = await res.json();
        if (data.success) {
          joinRoom(data.roomId);
        } else {
          alert(data.error);
        }
      });

      window.createRoom = async () => {
        alert('Create button clicked (onclick)');
        const name = newRoomName.value.trim();
        if (!name) {
          alert('Enter room name');
          return;
        }
        alert('Sending request');
        const res = await fetch('/create-room', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, isPrivate: isPrivate.checked, password: roomPassword.value })
        });
        alert('Response received');
        const data = await res.json();
        if (data.success) {
          joinRoom(data.roomId);
        } else {
          alert(data.error);
        }
      };

      function joinRoom(roomId) {
        alert('Joining room ' + roomId);
        currentRoom = roomId;
        socket.emit('join room', roomId);
        overlay.style.display = 'none';
      }
      function renderMessage(msg){
        let text = '';
        let time = new Date().toLocaleTimeString();
        let senderId = null;
        let sender = 'Anonymous';

        if (typeof msg === 'string') { text = msg; }
        else if (msg && typeof msg === 'object'){
          text = msg.text || '';
          senderId = msg.id || null;
          sender = msg.username || 'Anonymous';
          if (msg.time) try{ time = new Date(msg.time).toLocaleTimeString(); }catch(e){}
        }

        const item = document.createElement('li');
        const isMine = senderId === socket.id || sender === username;
        item.className = 'message ' + (isMine ? 'mine' : 'other');

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = (sender || 'A').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();

        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.innerHTML = `<div class="sender">${escapeHtml(sender)}</div><div class="text">${escapeHtml(text)}</div><span class="meta">${time}</span>`;

        item.appendChild(avatar);
        item.appendChild(bubble);
        messages.appendChild(item);
        // keep scroll near bottom
        messages.scrollTop = messages.scrollHeight - messages.clientHeight;
      }

      // simple escaping to avoid accidental HTML injection
      function escapeHtml(str){
        return String(str)
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/\"/g,'&quot;')
          .replace(/'/g,'&#39;');
      }

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!username || !currentRoom) return;
        const value = input.value && input.value.trim();
        if (!value) return;
        const message = { text: value, id: socket.id, username, time: new Date().toISOString(), roomId: currentRoom };
        socket.emit('chat message', message);
        input.value = '';
      });
        socket.emit('chat message', message);
        input.value = '';
        renderMessage(message);
        input.focus();
      });

      // also send on Enter when focus is on input
      input.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); form.requestSubmit(); }
      });

      // receive history on connect
      socket.on('history', (arr) => {
        try{
          (arr || []).forEach(renderMessage);
        }catch(e){console.error('Failed rendering history',e)}
      });

      socket.on('chat message', (msg) => {
        // when we receive, if it's from ourselves we may already have rendered it optimistically
        if (msg && typeof msg === 'object' && (msg.id === socket.id || msg.username === username)) return;
        renderMessage(msg);
      });

      // Join flow
      function joinChat(name){
        const trimmedName = (name || 'Anonymous').trim().slice(0,30) || 'Anonymous';
        if (trimmedName === '') return; // don't allow empty join
        username = trimmedName;
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden', 'true');
        input.focus();
        console.log('Joined as:', username);
      }

      joinBtn.addEventListener('click', ()=>{
        const name = (usernameInput.value || '').trim();
        if (name) joinChat(name);
      });

      usernameInput.addEventListener('keydown', (e)=>{ 
        if (e.key === 'Enter') {
          const name = (usernameInput.value || '').trim();
          if (name) joinChat(name);
        }
      });
    </script>
  </body>
</html>
